import { NextRequest, NextResponse } from 'next/server'

const WORDPRESS_API_URL = process.env.NEXT_PUBLIC_WORDPRESS_API_URL || 'https://new.igihe.com/wp-json/wp/v2'

// Simple in-memory cache (consider Redis for production)
const cache = new Map()

interface CacheEntry {
  data: any
  expiry: number
}

// Mock data for development when WordPress is not available
const mockData = {
  'posts': {
    data: [
      {
        id: 1,
        date: new Date().toISOString(),
        slug: 'sample-post-1',
        title: { rendered: 'Sample Post Title 1' },
        excerpt: { rendered: '<p>This is a sample excerpt for development purposes.</p>' },
        content: { rendered: '<p>This is sample content for development.</p>' },
        featured_media: 0,
        categories: [1],
        tags: [],
        _embedded: {
          author: [{ id: 1, name: 'Admin', slug: 'admin' }],
          'wp:featuredmedia': [],
          'wp:term': [[{ id: 1, name: 'News', slug: 'news' }]]
        }
      },
      {
        id: 2,
        date: new Date().toISOString(),
        slug: 'sample-post-2',
        title: { rendered: 'Sample Post Title 2' },
        excerpt: { rendered: '<p>Another sample excerpt for development.</p>' },
        content: { rendered: '<p>More sample content here.</p>' },
        featured_media: 0,
        categories: [1],
        tags: [],
        _embedded: {
          author: [{ id: 1, name: 'Admin', slug: 'admin' }],
          'wp:featuredmedia': [],
          'wp:term': [[{ id: 1, name: 'News', slug: 'news' }]]
        }
      }
    ],
    pagination: {
      currentPage: 1,
      perPage: 10,
      totalPages: 1,
      totalItems: 2,
      hasNextPage: false
    }
  },
  'categories': [
    {
      id: 1,
      name: 'News',
      slug: 'news',
      count: 5,
      description: 'News category for development'
    },
    {
      id: 2,
      name: 'Sports',
      slug: 'sports',
      count: 3,
      description: 'Sports category for development'
    }
  ],
  'pvt/v1/popular-posts': [
    {
      id: 1,
      date: new Date().toISOString(),
      slug: 'popular-post-1',
      title: { rendered: 'Popular Post 1' },
      excerpt: { rendered: '<p>This is a popular post excerpt.</p>' },
      featured_media: 0,
      categories: [1],
      _embedded: {
        author: [{ id: 1, name: 'Admin', slug: 'admin' }],
        'wp:featuredmedia': []
      }
    }
  ],
  'advertisement': [],
  'igh-yt-videos': [],
  'opinion': [],
  'fact-of-the-day': [
    {
      id: 1,
      title: { rendered: 'Sample Fact' },
      excerpt: { rendered: '<p>This is a sample fact for development.</p>' },
      content: { rendered: '<p>Interesting fact content here.</p>' },
      _embedded: {}
    }
  ],
  'announcement': [],
  'advertorial': []
}

// Check if we're in development mode and should use mock data
const useMockData = process.env.NODE_ENV === 'development' && 
  (!process.env.NEXT_PUBLIC_WORDPRESS_API_URL || 
   process.env.NEXT_PUBLIC_WORDPRESS_API_URL.includes('localhost'))

export async function GET(
  request: NextRequest,
  context: { params: Promise<{ path: string[] }> }
) {
  try {
    // Await the params in Next.js 14+
    const { path } = await context.params
    const searchParams = request.nextUrl.searchParams
    
    // Create cache key
    const cacheKey = `proxy:${path.join('/')}:${searchParams.toString()}`
    
    // Check cache first
    const cached = cache.get(cacheKey) as CacheEntry | undefined
    if (cached && Date.now() < cached.expiry) {
      return NextResponse.json(cached.data, {
        headers: {
          'Cache-Control': 'public, s-maxage=300, stale-while-revalidate=600',
          'X-Cache': 'HIT',
          'X-Proxy': 'NextJS-WordPress-Proxy',
        },
      })
    }

    // Use mock data in development if WordPress is not available
    if (useMockData) {
      const pathKey = path.join('/')
      let mockResponse = mockData[pathKey as keyof typeof mockData]
      
      // Handle pagination for posts
      if (pathKey === 'posts' && mockResponse) {
        const page = parseInt(searchParams.get('page') || '1')
        const per_page = parseInt(searchParams.get('per_page') || '10')
        
        if (mockResponse.data) {
          const postsData = { ...mockResponse }
          postsData.pagination = {
            ...postsData.pagination,
            currentPage: page,
            perPage: per_page
          }
          mockResponse = postsData
        }
      }
      
      if (mockResponse !== undefined) {
        console.log('Using mock data for:', pathKey)
        
        // Cache mock responses too
        cache.set(cacheKey, {
          data: mockResponse,
          expiry: Date.now() + 60000 // 1 minute for mock data
        })
        
        return NextResponse.json(mockResponse, {
          headers: {
            'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=120',
            'X-Cache': 'MOCK',
            'X-Proxy': 'NextJS-Mock-Data',
          },
        })
      }
    }

    // Proceed with actual WordPress API call
    const wordpressUrl = `${WORDPRESS_API_URL}/${path.join('/')}?${searchParams.toString()}`
    
    console.log('Proxying to:', wordpressUrl)
    
    const response = await fetch(wordpressUrl, {
      headers: {
        'User-Agent': 'Igihe-NextJS-Proxy/1.0',
      },
    })

    if (!response.ok) {
      // If WordPress API fails, try to return mock data as fallback
      if (process.env.NODE_ENV === 'development') {
        const pathKey = path.join('/')
        const mockResponse = mockData[pathKey as keyof typeof mockData]
        if (mockResponse !== undefined) {
          console.log('WordPress API failed, using mock data for:', pathKey)
          return NextResponse.json(mockResponse, {
            headers: {
              'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=120',
              'X-Cache': 'MOCK-FALLBACK',
              'X-Proxy': 'NextJS-Mock-Fallback',
            },
          })
        }
      }
      
      return NextResponse.json(
        { error: 'WordPress API error', status: response.status },
        { status: response.status }
      )
    }

    const data = await response.json()
    
    // Cache based on endpoint type
    let cacheTtl = 300000 // 5 minutes default
    if (path.includes('posts')) cacheTtl = 120000 // 2 minutes for posts
    if (path.includes('categories')) cacheTtl = 1800000 // 30 minutes for categories
    
    // Store in cache
    cache.set(cacheKey, {
      data,
      expiry: Date.now() + cacheTtl
    })

    return NextResponse.json(data, {
      headers: {
        'Cache-Control': 'public, s-maxage=300, stale-while-revalidate=600',
        'X-Cache': 'MISS',
        'X-Proxy': 'NextJS-WordPress-Proxy',
      },
    })
  } catch (error) {
    console.error('Proxy error:', error)
    
    // Return mock data on error in development
    if (process.env.NODE_ENV === 'development') {
      const { path } = await context.params
      const pathKey = path.join('/')
      const mockResponse = mockData[pathKey as keyof typeof mockData]
      
      if (mockResponse !== undefined) {
        console.log('Error occurred, using mock data for:', pathKey)
        return NextResponse.json(mockResponse, {
          headers: {
            'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=120',
            'X-Cache': 'MOCK-ERROR',
            'X-Proxy': 'NextJS-Mock-Error',
          },
        })
      }
    }
    
    const errorMessage = error instanceof Error ? error.message : 'Internal server error'
    
    return NextResponse.json(
      { error: errorMessage },
      { status: 500 }
    )
  }
}